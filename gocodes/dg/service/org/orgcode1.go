package org

import (
	"codes/gocodes/dg/utils/math"
	"github.com/pkg/errors"
)

func main() {
	//xx := GetOrgCodesToBeAllocate(0, 0)
	//fmt.Print(xx)
	// [100000000 200000000 300000000 400000000 500000000 600000000 700000000 800000000 900000000 1000000000 1100000000 1200000000 1300000000 1400000000 1500000000 1600000000 1700000000 1800000000 1900000000 2000000000 2100000000 2200000000 2300000000 2400000000 2500000000 2600000000 2700000000 2800000000 2900000000 3000000000 3100000000 3200000000 3300000000 3400000000 3500000000 3600000000 3700000000 3800000000 3900000000 4000000000 4100000000 4200000000 4300000000 4400000000 4500000000 4600000000 4700000000 4800000000 4900000000 5000000000 5100000000 5200000000 5300000000 5400000000 5500000000 5600000000 5700000000 5800000000 5900000000 6000000000 6100000000 6200000000 6300000000 6400000000 6500000000 6600000000 6700000000 6800000000 6900000000 7000000000 7100000000 7200000000 7300000000 7400000000 7500000000 7600000000 7700000000 7800000000 7900000000 8000000000 8100000000 8200000000 8300000000 8400000000 8500000000 8600000000 8700000000 8800000000 8900000000 9000000000 9100000000 9200000000 9300000000 9400000000 9500000000 9600000000 9700000000 9800000000 9900000000]

	//xx := GetOrgCodesToBeAllocate(1, 100000000)
	//fmt.Print(xx)
	// [101000000 102000000 103000000 104000000 105000000 106000000 107000000 108000000 109000000 110000000 111000000 112000000 113000000 114000000 115000000 116000000 117000000 118000000 119000000 120000000 121000000 122000000 123000000 124000000 125000000 126000000 127000000 128000000 129000000 130000000 131000000 132000000 133000000 134000000 135000000 136000000 137000000 138000000 139000000 140000000 141000000 142000000 143000000 144000000 145000000 146000000 147000000 148000000 149000000 150000000 151000000 152000000 153000000 154000000 155000000 156000000 157000000 158000000 159000000 160000000 161000000 162000000 163000000 164000000 165000000 166000000 167000000 168000000 169000000 170000000 171000000 172000000 173000000 174000000 175000000 176000000 177000000 178000000 179000000 180000000 181000000 182000000 183000000 184000000 185000000 186000000 187000000 188000000 189000000 190000000 191000000 192000000 193000000 194000000 195000000 196000000 197000000 198000000 199000000]

	//xx := GetOrgCodesToBeAllocate(2, 199000000)
	//fmt.Print(xx)
	// [199010000 199020000 199030000 199040000 199050000 199060000 199070000 199080000 199090000 199100000 199110000 199120000 199130000 199140000 199150000 199160000 199170000 199180000 199190000 199200000 199210000 199220000 199230000 199240000 199250000 199260000 199270000 199280000 199290000 199300000 199310000 199320000 199330000 199340000 199350000 199360000 199370000 199380000 199390000 199400000 199410000 199420000 199430000 199440000 199450000 199460000 199470000 199480000 199490000 199500000 199510000 199520000 199530000 199540000 199550000 199560000 199570000 199580000 199590000 199600000 199610000 199620000 199630000 199640000 199650000 199660000 199670000 199680000 199690000 199700000 199710000 199720000 199730000 199740000 199750000 199760000 199770000 199780000 199790000 199800000 199810000 199820000 199830000 199840000 199850000 199860000 199870000 199880000 199890000 199900000 199910000 199920000 199930000 199940000 199950000 199960000 199970000 199980000 199990000]

	//xx := GetOrgCodesToBeAllocate(3, 199990000)
	//fmt.Print(xx)
	// [199990100 199990200 199990300 199990400 199990500 199990600 199990700 199990800 199990900 199991000 199991100 199991200 199991300 199991400 199991500 199991600 199991700 199991800 199991900 199992000 199992100 199992200 199992300 199992400 199992500 199992600 199992700 199992800 199992900 199993000 199993100 199993200 199993300 199993400 199993500 199993600 199993700 199993800 199993900 199994000 199994100 199994200 199994300 199994400 199994500 199994600 199994700 199994800 199994900 199995000 199995100 199995200 199995300 199995400 199995500 199995600 199995700 199995800 199995900 199996000 199996100 199996200 199996300 199996400 199996500 199996600 199996700 199996800 199996900 199997000 199997100 199997200 199997300 199997400 199997500 199997600 199997700 199997800 199997900 199998000 199998100 199998200 199998300 199998400 199998500 199998600 199998700 199998800 199998900 199999000 199999100 199999200 199999300 199999400 199999500 199999600 199999700 199999800 199999900]

	//xx := GetOrgCodesToBeAllocate(4, 199999900)
	//fmt.Print(xx)
	// [199999901 199999902 199999903 199999904 199999905 199999906 199999907 199999908 199999909 199999910 199999911 199999912 199999913 199999914 199999915 199999916 199999917 199999918 199999919 199999920 199999921 199999922 199999923 199999924 199999925 199999926 199999927 199999928 199999929 199999930 199999931 199999932 199999933 199999934 199999935 199999936 199999937 199999938 199999939 199999940 199999941 199999942 199999943 199999944 199999945 199999946 199999947 199999948 199999949 199999950 199999951 199999952 199999953 199999954 199999955 199999956 199999957 199999958 199999959 199999960 199999961 199999962 199999963 199999964 199999965 199999966 199999967 199999968 199999969 199999970 199999971 199999972 199999973 199999974 199999975 199999976 199999977 199999978 199999979 199999980 199999981 199999982 199999983 199999984 199999985 199999986 199999987 199999988 199999989 199999990 199999991 199999992 199999993 199999994 199999995 199999996 199999997 199999998 199999999]
}

const (
	RootOrgLevel   = 1
	RootOrgCode    = -1
	InValidOrgCode = -2
)

var (
	MaxOrgNumPerLevel int64
	MaxOrgLevel       int64
	MaxOrgNum         int64
)

func init() {
	LoadOrgConfVal()
}
func LoadOrgConfVal() {
	MaxOrgNumPerLevel = 100
	MaxOrgLevel = 4
	MaxOrgNum = math.PowInt64(MaxOrgNumPerLevel, MaxOrgLevel)
}

func GetOrgCodesToBeAllocate(superOrgLevel, superOrgCode int64) []int64 {
	var orgCodes []int64
	for i := 1; i < int(MaxOrgNumPerLevel); i++ {
		orgCodes = append(orgCodes, superOrgCode+int64(i)*(MaxOrgNum/(math.PowInt64(MaxOrgNumPerLevel, superOrgLevel))))
	}
	return orgCodes
}

//func CheckAndPickNewOrgCode(tobeAllocate, allocated []int64) (int64, error) {
//	remainedOrgCode := slice.GetDiffIntSet(tobeAllocate, allocated)
//	if len(remainedOrgCode) == 0 {
//		fmt.Print("err org code")
//		return InValidOrgCode, fmt.Errorf("[OrgCode] no org code remaining, len(allocated):%v, len(tobeAllocate):%v, allocated:%v\n, tobeAllocate:%v", len(allocated), len(tobeAllocate), allocated, tobeAllocate)
//	}
//	return remainedOrgCode[0], nil // random pick one
//}

//---------------capture search---------------
type OrgCodeRange struct {
	IsNeedInSQL bool  // if root org(level 0): false
	MinOrgCode  int64 // >=
	MaxOrgCode  int64 // <
}

func GetOrgCodeRange(orgCode int64) (*OrgCodeRange, error) {
	if orgCode == RootOrgCode { // level 0
		return &OrgCodeRange{
			IsNeedInSQL: false,
		}, nil
	}

	var level int64
	var isValid bool
	for level = 1; level <= MaxOrgLevel; level++ {
		if orgCode%(math.PowInt64(MaxOrgNumPerLevel, MaxOrgLevel-level)) == 0 {
			isValid = true
			break
		}
	}
	if !isValid { // should not arrive
		return nil, errors.Errorf("[GetOrgCodeRange] not invalid orgCode:%v", orgCode)
	}

	_orgStep := MaxOrgNum / math.PowInt64(MaxOrgNumPerLevel, level-1)
	return &OrgCodeRange{
		IsNeedInSQL: true,
		MinOrgCode:  orgCode,
		MaxOrgCode:  orgCode + _orgStep,
	}, nil
}
